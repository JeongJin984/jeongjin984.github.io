---
title: Saga Orchestratorì— ëŒ€í•´ì„œ
description: >-
  Saga Orchestratorì— ëŒ€í•´ì„œ
author: jay
date: 2025-05-18 20:55:00 +0800
categories: [Retrospect, Geeson]
tags: [kafka, saga, spring]
pin: false
media_subpath: ''
---

# Saga Orchestrator

## Monolithic vs MSA

**Monolithic**

Monolithicì˜ ìµœëŒ€ ì¥ì ì€ Transaction, Component(í”„ë¡œì„¸ìŠ¤, ì„œë²„)ë¥¼ ê´€ë¦¬í•˜ê¸° ì‰½ë‹¤ëŠ” ê²ƒì´ë‹¤. ì¤‘ê°„ì— ë­ê°€ ì˜ëª»ë˜ì—ˆë‹¤ë©´ DBì—ì„œ ì§€ì›í•˜ëŠ” Transantion ê´€ë¦¬ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë©´ ëœë‹¤. ê·¸ëŸ¬ë©´ Rollbackë„ ì‰½ë‹¤. 

í•˜ì§€ë§Œ ì¥ì ì´ ëšœë ·í•œ ë§Œí¼ ë‹¨ì ë„ ëšœë ·í•˜ë‹¤. ë³´í†µ ì¼ë°˜ì ì¸ ì„œë¹„ìŠ¤ëŠ” ì§€ì†ì ìœ¼ë¡œ í™•ì¥ë˜ê³  ë³€ê²½ëœë‹¤. ì´ˆê¸°ì—ëŠ” í° ë¬¸ì œê°€ ë˜ì§€ ì•Šì§€ë§Œ ì´ê²ƒ ì €ê²ƒ ì„œë¹„ìŠ¤ì— ê¸°ëŠ¥ë“¤ì„ ì¶”ê°€í•˜ê²Œ ë˜ë©´ ì ì  ì„œë¹„ìŠ¤ëŠ” ë¬´ê±°ì›Œ ì§€ê³  ìœ ì§€ë³´ìˆ˜ê°€ ì–´ë µê²Œ ëœë‹¤. ê²Œë‹¤ê°€ í•˜ë‚˜ì˜ ì¥ì• ê°€ ì—¬ëŸ¬ ë‹¤ë¥¸ ê¸°ëŠ¥ë“¤ì— ì „íŒŒë  ìˆ˜ ìˆëŠ” ì—¬ì§€ë„ ì¶©ë¶„íˆ ìˆë‹¤.

**MSA**

MSAì— ëŒ€í•´ì„œëŠ” ì‚¬ì‹¤ ìµœê·¼ê¹Œì§€ ì•ˆì¢‹ì€ ì¸ì‹ì´ ìˆì—ˆë˜ ê²ƒì´ ì‚¬ì‹¤ì´ë‹¤. ì™œëƒí•˜ë©´ MSAëŠ” ê·¸ë§Œí¼ ë„ë©”ì¸ì— ëŒ€í•œ ì„¤ê³„ë„ ì˜ ë˜ì–´ìˆì–´ì•¼í•  ë¿ì•„ë‹ˆë¼ ê° ì»´í¬ë„ŒíŠ¸ë¥¼ ê´€ë¦¬í•˜ëŠ” ê¸°ìˆ (ëŒ€í¬ì ìœ¼ë¡œ k8s)ì— ëŒ€í•œ ì´í•´ë„ë„ ë†’ì•„ì•¼í•œë‹¤. ê·¸ë¦¬ê³  í•˜ë‚˜ì˜ Transactionì„ ë¶„ë¦¬í•œë‹¤ëŠ” ê²ƒì€ ê·¸ë§Œí¼ ì„œë¹„ìŠ¤ê°€ ë¶ˆì•ˆì •í•´ ì§„ë‹¤ëŠ” ê²ƒì´ë‹¤. ë”°ë¼ì„œ êµ³ì´ ì´ëŸ° ë‹¨ì ì„ ê°€ì ¸ê°€ë©´ì„œë„ MSAëŠ” í•´ì•¼í•˜ëŠ” ì´ìœ ì— ëŒ€í•´ì„œ ì˜ì‹¬ìŠ¤ëŸ¬ì› ë‹¤.

í•˜ì§€ë§Œ ì´ë²ˆ í”„ë¡œì íŠ¸ë¥¼ í†µí•´ ì–´ë ´í’‹ì´ë‚˜ë§ˆ í•„ìš”ì„±ì— ëŒ€í•´ì„œ ëŠë¼ê²Œ ë˜ì—ˆë‹¤. MSAì˜ ìµœëŒ€ ì¥ì ì€ ì„œë¹„ìŠ¤ë¥¼ ë¶„ë¦¬í•˜ê³  Kafkaê°™ì€ ê¸°ìˆ ì„ í™œìš©í•´ì„œ ì„œë¹„ìŠ¤ë¥¼ ì„œë¡œê°„ì— ì•½í•˜ê²Œ ê²°í•©í•œë‹¤ëŠ” ê²ƒì´ë‹¤. ì•½í•˜ê²Œ ê²°í•©ëœ ì„œë¹„ìŠ¤ëŠ” ì„œë¹„ìŠ¤ë¥¼ í™•ì¥ì‹œí‚¤ëŠ” ê²ƒì— ëŒ€í•´ì„œ êµ‰ì¥í•œ í¸ì˜ì„±ì„ ì œê³µí•œë‹¤. ë‹¨ìˆœíˆ ì´ë²¤íŠ¸ë¥¼ êµ¬ë…í•˜ê³  ì†Œë¹„í•˜ëŠ” ê²ƒìœ¼ë¡œ ì‹ ê·œ ì„œë¹„ìŠ¤ë¥¼ ë§Œë“¤
ìˆ˜ ìˆì„ ê²ƒì´ë‹¤.

## Saga Orchestration 
  
ì´ë²ˆ í”„ë¡œì íŠ¸ëŠ” MSA ì•„í‚¤í…ì²˜ë¥¼ êµ¬ì„±í•˜ëŠ” ê²ƒì´ê¸° ë•Œë¬¸ì— ë¶„ì‚°ëœ íŠ¸ëœì­ì…˜ì„ ì»¨íŠ¸ë¡¤ í•  í•„ìš”ê°€ ìˆë‹¤. ë‚´ê°€ ì„ íƒí•œ ì‹œë‚˜ë¦¬ì˜¤ëŠ” ì£¼ë¬¸ -> ê²°ì œ -> ì¬ê³  ì˜ ê³¼ì •ì—ì„œì˜ ë¶„ì‚°ëœ íŠ¸ëœì­ì…˜ì„ ê´€ë¦¬í•˜ëŠ” ê²ƒì´ ëª©í‘œì˜€ë‹¤.

ì´ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ 3ê°€ì§€ ë°©ë²•ì´ ìˆëŠ”ë° Two-Phase Commit(2PC), ë³´ìƒ íŠ¸ëœì­ì…˜ ê¸°ë°˜ì˜ Saga íŒ¨í„´(Orchestration(ì¤‘ì•™ ì¡°ì •ì), Choreography(ê° ì„œë¹„ìŠ¤ê°€ ì´ë²¤íŠ¸ ê¸°ë°˜ìœ¼ë¡œ ë°˜ì‘))ì´ ìˆë‹¤. 

### 2PC

ì´ ë°©ë²•ì€ ëª¨ë“  ì°¸ì—¬ìì— prepare ìš”ì²­ì„ í•˜ê³  ëª¨ë‘ OKí•˜ë©´ Sagaë¥¼ í—ˆìš©í•˜ëŠ” ê²ƒì´ë‹¤. ì´ ë°©ë²•ì€ ëª¨ë“  ì°¸ì—¬ ì‹œìŠ¤í…œìœ¼ë¡œ ë™ê¸°ì ìœ¼ë¡œ ì—°ê²°ë˜ì–´ì•¼ í•œë‹¤ëŠ” íŠ¹ì§•ì´ ìˆëŠ”ë° ì‚¬ì‹¤ ê°€ì¥ ê°„ë‹¨í•˜ë‹¤ ì¦‰ ì¥ì• ë¥¼ í—ˆìš©í•˜ì§€ ì•Šê² ë‹¤ëŠ” ê²ƒì¸ë° ì‚¬ì‹¤ MSAì—ì„œëŠ” í•˜ë‚˜ì˜ Sagaì— ì°¸ì—¬í•˜ê³  ìˆëŠ” Componentê°€ í•œë‘ê°œë„ ì•„ë‹ˆê³  ê·¸ ì¤‘ì—ì„œëŠ” ì‘ë™í•˜ì§€ ì•Šì•„ë„ ê´œì°®ì€(ë‚´ë¶€ ì•ŒëŸ¿ê°™ì€) Componentê°€ ìˆì„ ìˆ˜ ìˆê³  ê²°êµ­ í™•ì¸ -> commitì˜ ê³¼ì •ì„ ê±°ì¹˜ëŠ”ë° í™•ì¸ ê³¼ì •ì—ì„œ ë¬¸ì œê°€ ì—†ë‹¤ê°€ commitì—ì„œ ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆëŠ” ì—¬ì§€ëŠ” ì¶©ë¶„íˆ ìˆë‹¤.

ê·¸ë¦¬ê³  í•˜ë‚˜ì˜ Componentê°€ ì‘ë‹µì´ ëŠë¦¬ë©´ ëª¨ë“  ì„œë¹„ìŠ¤ê°€ ì‘ë‹µì´ ëŠë ¤ì§€ê¸° ë•Œë¬¸ì— êµ‰ì¥íˆ ë¹„íš¨ìœ¨ ì ì´ë¼ê³  ìƒê°í•œë‹¤.

ì´ëŸ´ê±°ë©´ ê·¸ëƒ¥ ì°¨ë¼ë¦¬ ê·¸ Sagaë¥¼ ìœ„í•œ í•˜ë‚˜ì˜ ì„œë²„ë¥¼ êµ¬ì„±í•˜ëŠ” ê²ƒì´ í›¨ì”¬ íš¨ìœ¨ì ì¼ ìˆ˜ ìˆë‹¤ëŠ” ìƒê°ì„ í–ˆë‹¤.

### Choreography

ì´ ë°©ì‹ì€ ê° ì„œë¹„ìŠ¤ê°€ ì´ë²¤íŠ¸ë¡œ ë°˜ì‘í•˜ë©° Sagaë¥¼ ì»¨íŠ¸ë¡¤ í•˜ëŠ”ë° ì´ ë°©ì‹ì€ ì „ì²´ì ì¸ íë¦„ì´ ì˜ ë³´ì´ì§€ê°€ ì•ŠëŠ”ë‹¤. MSAì˜ ê° Architecureì˜ ë…ë¦½ì„±ì´ë¼ëŠ” ëª©ì ì—ëŠ” ë¶€í•©í•˜ì§€ë§Œ ì´ë•Œë¬¸ì— ì „ì²´ì ì¸ íë¦„ì„ í•œëˆˆì— íŒŒì•…í•˜ê¸° ì–´ë µê³  ì¥ì• ë‚˜ ì§€ì—°ì´ ë°œìƒí•˜ë©´ ë””ë²„ê¹…ì´ í˜ë“¤ë‹¤

ë¬¼ë¡  ê° ì„œë¹„ìŠ¤ë¥¼ ëŠìŠ¨í•˜ê²Œ ê²°í•©í•œë‹¤ëŠ” ì›ì¹™ì„ ì§€í‚¤ê³  ìˆê¸° ë•Œë¬¸ì— ì„œë¹„ìŠ¤ê°„ì˜ ë…ë¦½ì„±ì„ ë³´ì¥í•˜ê³  í™•ì¥ì„±ê³¼ ìœ ì§€ ë³´ìˆ˜ì„±ì´ ìš°ìˆ˜í•˜ë©° íƒ„ë ¥ì„±ì´ ë†’ë‹¤ëŠ” ì ì—ì„œ MSAì˜ ì •ì˜ì˜ ê´€ì ì—ì„œëŠ” ë”ìš± ì í•©í•œ ë°©ì‹ìœ¼ë¡œ íŒë‹¨ í•  ìˆ˜ ìˆë‹¤.

### Orchestration

ì´ ë°©ë²•ì€ Sagaë¥¼ ì²˜ë¦¬í•˜ëŠ” ì¤‘ì•™í™”ëœ ì¡°ì •ìê°€ ë”°ë¡œ ì¡´ì¬í•˜ê³  ê·¸ ì¡°ì •ìëŠ” ì „ì²´ì ì¸ Sagaì˜ íë¦„ì„ ê´€ë¦¬í•˜ëŠ” ì—­í• ë§Œ í•˜ëŠ” ê²ƒì´ë‹¤. ì´ ë°©ë²•ì€ ë³µì¡í•œ ë¡œì§ì„ ì¤‘ì•™ ì§‘ì¤‘ì ìœ¼ë¡œ ê´€ë¦¬ ê°€ëŠ¥í•˜ë‹¤ëŠ” ì¥ì ì´ ìˆì§€ë§Œ SPOFê°€ ë°œìƒí•  ìˆ˜ ìˆëŠ” ì—¬ì§€ê°€ ìˆê³  ì „ì²´ì ì¸ ì„œë¹„ìŠ¤ê°€ ì¡°ì •ì ì•„ë˜ ê²°í•©ë„ê°€ ìƒëŒ€ì ìœ¼ë¡œ ë†’ì•„ì§„ë‹¤ëŠ” ë‹¨ì ì´ ìˆë‹¤.

ì´ ë°©ë²•ì„ ì‚¬ìš©í•´ì„œ Sagaë¥¼ êµ¬í˜„í•˜ì˜€ëŠ”ë° MSAëŠ” Monolithicì— ë¹„í•´ì„œ ì¥ì• ì— ì·¨ì•½í•˜ë‹¤. MSAëŠ” êµ‰ì¥íˆ íš¨ìœ¨ì ì´ê³  íŠ¼íŠ¼í•˜ë‹¤ê³  ì°©ê°í•  ìˆ˜ ìˆë‹¤ê³  ìƒê°í•˜ëŠ”ë° ì˜¤íˆë ¤ MSAëŠ” ë¹„íš¨ìœ¨ì ì´ê³ (ì„œë¹„ìŠ¤ê°€ ê°„ë‹¨í•˜ë©´ ê°„ë‹¨í• ìˆ˜ë¡) ì¥ì• ì— ì·¨ì•½í•˜ë‹¤. 

MSAì—ì„œëŠ” ì˜¤íˆë ¤ ì¥ì• ë¥¼ ì›ì²œì ìœ¼ë¡œ ë§‰ëŠ” ê²ƒ ë³´ë‹¤ëŠ” ì¶”ì  ë° ë³µêµ¬ê°€ ê°€ëŠ¥í•œ ì„œë¹„ìŠ¤ë¥¼ êµ¬ì„±í•˜ëŠ” ê²ƒì´ ë”ìš± ì¤‘ìš”í•œ ê³¼ì œì´ë‹¤. ì´ëŸ¬í•œ ì¸¡ë©´ì—ì„œ ë³µì¡í•œ Saga íë¦„ì„ êµ¬í˜„í•˜ëŠ” ê²ƒì€ Choreography ë°©ì‹ë³´ë‹¤ Orchestration ë°©ì‹ì´ ë” ê²¬ê³ í•œ ì‹œìŠ¤í…œì„ ë§Œë“œëŠ”ë° ì í•©í•˜ë‹¤ê³  íŒë‹¨í–ˆë‹¤.   

**ì •ë¦¬í•˜ìë©´**

```markdown
ğŸŸ¢ Orchestrator ì í•©í•œ ê²½ìš°

ì „ì²´ íë¦„ì´ ë³µì¡í•˜ê±°ë‚˜ ì •í˜•í™”ë˜ì–´ ìˆëŠ” ê²½ìš° (ì˜ˆ: ì£¼ë¬¸ â†’ ê²°ì œ â†’ ì¬ê³  â†’ ë°°ì†¡)

ì‹¤íŒ¨ ë³´ìƒ ë¡œì§ì´ ë³µì¡í•˜ê³ , í•œëˆˆì— í†µì œí•  í•„ìš”ê°€ ìˆì„ ë•Œ

ë¹ ë¥¸ ê°œë°œ ë° ë‹¨ìˆœí•œ ìš´ì˜/ë””ë²„ê¹… í™˜ê²½ì´ ì¤‘ìš”í•œ ê²½ìš°

íŒ€ ì—­ëŸ‰ìƒ tracing/log aggregationì„ ì•„ì§ ì¤€ë¹„í•˜ì§€ ì•Šì•˜ì„ ë•Œ
```

```markdown
ğŸ”µ Choreography + OpenTelemetry ì í•©í•œ ê²½ìš°

ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ê°„ ê²°í•©ë„ë¥¼ ë‚®ì¶”ê³ ì í•  ë•Œ

ì´ë²¤íŠ¸ ì¤‘ì‹¬ ì•„í‚¤í…ì²˜ê°€ ê¸°ì¡´ì— ìë¦¬ì¡ê³  ìˆì„ ë•Œ

ì„œë¹„ìŠ¤ê°€ ë…ë¦½ì ìœ¼ë¡œ ì§„í™”í•˜ê³ , ë‹¤ì–‘í•œ ì†Œë¹„ìê°€ ìƒê¸¸ ê°€ëŠ¥ì„±ì´ ë†’ì„ ë•Œ

**ê´€ì¸¡ì„±(Observability)**ì„ ê°•í™”í•˜ë ¤ëŠ” ì „ëµì´ ëª…í™•í•  ë•Œ
```

ë”°ë¼ì„œ Backbone ì‹œìŠ¤í…œ(ì£¼ë¬¸, ê²°ì œ, ì¬ê³ , ì •ì‚°)ë“±ì˜ ì‹œìŠ¤í…œì€ MSAì˜ ë…ë¦½ì„±, íƒ„ë ¨ì„ì„ ì–´ëŠì •ë„ í¬ê¸°í•˜ê³  Orchestrator ê¸°ë°˜ìœ¼ë¡œ êµ¬í˜„í•˜ê³  ê²°ì œ notification, ì¿ í° ë°œê¸‰, ì´ë©”ì¼ ì „ì†¡ë“±ì˜ SagaëŠ” Choreographyë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ë§ë‹¤ê³  íŒë‹¨í–ˆë‹¤.


## ë¶„ì‚° íŠ¸ëœì­ì…˜

> ê·¸ë˜ì„œ ë¶„ì‚° íŠ¸ëœì­ì…˜ì„ Orchestratorì—ì„œ ì–´ë–»ê²Œ êµ¬í˜„í•  ê±´ë°?

### Kafka

KafkaëŠ” Httpì™€ëŠ” ë‹¤ë¥´ê²Œ ì‘ë‹µì„ ê¸°ë‹¤ë¦¬ì§€ ì•ŠëŠ”ë‹¤. ì´ë²¤íŠ¸ëŠ” ë°œì†¡ë˜ê¸°ë§Œ í•  ë¿ ê·¸ì— ë”°ë¥¸ ì‘ë‹µì„ ì–»ì„ ìˆœ ì—†ë‹¤. ëª¨ë“  ê²ƒì´ ë¹„ë™ê¸°ì ì´ë¼ëŠ” ë§ì´ë‹¤. OrchestratorëŠ” Kafkaì˜ ì–´ì©Œë©´ ë‹¨ì ì¼ ìˆ˜ ìˆëŠ” ì ì„ í•´ê²°í•˜ê¸° ìœ„í•´ ì„±ê³µê³¼ ì‹¤íŒ¨ë¥¼ ì´ë²¤íŠ¸ë¡œ ìˆ˜ì‹ í•œë‹¤. kafka ë©”ì‹œì§€ë¥¼ commandì™€ eventë¡œ ë‚˜ëˆ„ì–´ì„œ ë§ˆì¹˜ Kafkaê°€ ë™ê¸°ì‹ìœ¼ë¡œ ìš´ì˜ë˜ëŠ” ê²ƒ ì²˜ëŸ¼ êµ¬í˜„í•˜ê³  ìˆë‹¤.

ë™ê¸°ì‹ìœ¼ë¡œ ìš´ì˜ë˜ëŠ” ê²ƒì„ ê¸°ëŒ€í•˜ê¸° ë•Œë¬¸ì— ì–´ì©Œë©´ ê²°í•©ë ¥ì´ ë†’ì•„ì¡Œë‹¤ê³  ë³¼ ìˆ˜ ìˆëŠ”ë° ì´ê±´ ì–´ì©” ìˆ˜ ì—†ëŠ” ê²ƒ ê°™ë‹¤.(ëŒ€ì‹  Transaction ê´€ë¦¬ê°€ ìš©ì´í•´ ì¡Œìœ¼ë‹ˆ...)

### Statemachine

ì—¬ê¸°ì„œ í•˜ë‚˜ì˜ ë¬¸ì œê°€ ë” ë°œìƒí•œë‹¤. ë°”ë¡œ ë³´ìƒ íŠ¸ëœì­ì…˜ì´ë‹¤. ì˜ˆë¥¼ë“¤ì–´ ê²°ì œê°€ ì„±ê³µí•˜ê³  ì¬ê³ ì—ì„œ ì‹¤íŒ¨ê°€ ë°œìƒí–ˆì„ ë•Œ ê²°ì œë¥¼ ì‹¤íŒ¨ ì²˜ë¦¬ í•´ì¤˜ì•¼í•œë‹¤. ì´ëŸ¬í•œ ë³´ìƒ íŠ¸ëœì­ì…˜ì„ ì„¬ì„¸í•˜ê²Œ ë‹¤ë¤„ì•¼ë§Œ ê²¬ê³ í•œ ì‹œìŠ¤í…œì„ ë§Œë“¤ ìˆ˜ ìˆë‹¤. ì•„ë˜ëŠ” ë‚´ê°€ ì‘ì„±í•œ ì‹œë‚˜ë¦¬ì˜¤ì´ë‹¤.

![Build source](/assets/img/retrospect_saga_img1.png){: .light .border .normal .center w=600' h='200' }

**Sagaì˜ ìƒíƒœê°€ ì´ë ‡ê²Œ ë³€í•˜ëŠ”ë° Sagaì˜ ìƒíƒœë¥¼ ì–´ë–»ê²Œ ê´€ë¦¬í•´ì•¼í• ê¹Œ?** 

ì²˜ìŒì—ëŠ” SagaInstanceì™€ ê° SagaStep(command ë°œí–‰)ì„ DBì— ì €ì¥í•˜ëŠ” ê²ƒìœ¼ë¡œ í•´ê²°í•˜ê³ ì í–ˆë‹¤. í•˜ì§€ë§Œ ê·¸ëŸ¼ì—ë„ ê° Listenerì—ì„œ ë‹¤ìŒ ì´ë²¤íŠ¸ë¥¼ ë°œí–‰í•˜ê³  ifë¬¸ì„ í†µí•´ ë¶„ê¸°ë¥¼ ì²˜ë¦¬í•˜ë‹¤ ë³´ë‹ˆ ê²°êµ­ ì „ì²´ì ì¸ íë¦„ì€ ì»¤ë…• Orchestratorê°€ ì ì  ë³µì¡í•´ ì§€ë©° ë””ë²„ê¹…ì´ í˜ë“¤ì–´ ì¡Œë‹¤. 

ê·¸ë˜ì„œ ChatGPTë¥¼ í†µí•´ ë°©ì•ˆì„ ëª¨ìƒ‰í•œ ê²°ê³¼ ìœ í•œìƒíƒœë¨¸ì‹ ì„ êµ¬í˜„í•  ìˆ˜ ìˆëŠ” Spring-Statementë¼ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ í†µí•´ ì´ ë¬¸ì œë¥¼ í•´ê²°í•  ìˆ˜ ìˆì—ˆë‹¤. statemachineì€ ì „ì²´ì ì¸ íë¦„ì„ Configurationì„  ê° ì´ë²¤íŠ¸ì— ë”°ë¼ commandë¥¼ ë°œí–‰í•˜ê³  ì´ë²¤íŠ¸ì— ë”°ë¼ ì–´ë–¤ stateë¡œ Transition ë˜ì–´ì•¼ í•˜ëŠ”ì§€ Configurationì„ í†µí•´ ëª…ì‹œí•  ìˆ˜ ìˆë‹¤. ì•„ë˜ëŠ” ìœ„ì˜ íë¦„ì„ Configurationì„ í†µí•´ ëª…ì‹œí•œ ì½”ë“œì´ë‹¤.

```java
@Override
public void configure(StateMachineTransitionConfigurer<OrderSagaState, OrderSagaEvent> transitions) throws Exception {
  transitions
    .withExternal()
    .source(ORDER_CREATED)
    .event(START_ORDER)
    .target(PAYMENT_REQUESTED)
    .action(paymentCommandGatewayGW.paymentRequestCommand())

    .and()
    .withExternal()
    .source(PAYMENT_REQUESTED)
    .event(PAYMENT_SUCCESS)
    .target(PAYMENT_COMPLETED)
    .action(inventoryCommandGateway.inventoryReserveCommand())

    .and()
    .withExternal()
    .source(PAYMENT_REQUESTED)
    .event(PAYMENT_FAILURE)
    .target(FAILED)

    .and()
    .withExternal()
    .source(PAYMENT_COMPLETED)
    .event(INVENTORY_SUCCESS)
    .target(INVENTORY_RESERVED)

    .and()
    .withExternal()
    .source(PAYMENT_COMPLETED)
    .event(INVENTORY_FAILURE)
    .target(COMPENSATING_PAYMENT)
    .action(paymentCommandGatewayGW.inventoryFailurePaymentCompensateCommand())

    .and()
    .withExternal()
    .source(COMPENSATING_PAYMENT)
    .event(PAYMENT_COMPENSATED)
    .target(COMPENSATING_INVENTORY)
    .action(inventoryCommandGateway.inventoryFailureInventoryCompensateCommand())

    .and()
    .withExternal()
    .source(COMPENSATING_INVENTORY)
    .event(INVENTORY_COMPENSATED)
    .target(COMPENSATED)

    .and()
    .withExternal()
    .source(COMPENSATING_PAYMENT)
    .event(PAYMENT_COMPENSATE_FAIL)
    .target(FAILED)
    .action(paymentCommandGatewayGW.paymentInventoryCompensateFailDLQ())

    .and()
    .withExternal()
    .source(COMPENSATING_INVENTORY)
    .event(INVENTORY_COMPENSATE_FAIL)
    .target(FAILED)
    .action(inventoryCommandGateway.inventoryInventoryCompensateFailDLQ())

    .and()
    .withExternal()
    .source(INVENTORY_RESERVED)
    .event(COMPLETE)
    .target(ORDER_COMPLETED);
}
```


